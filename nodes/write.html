<script type="text/javascript">
  function setupTypedInput(varName, types, def) {
    let varSel = '#node-input-' + varName;
    let typeSel = varSel + 'Type';
    let varVal = this[varName];
    let typeVal = this[varName + 'Type'];

    if (typeVal == null || typeVal === 'none') {
      typeVal = def;
    } else if (typeVal === 'string') {
      typeVal = "str";
    } else if (typeVal === 'number') {
      typeVal = "num";
    }
    $(typeSel).val(typeVal);
    $(varSel).typedInput({
      default: def,
      typeField: $(typeSel),
      types: types
    });
    $(varSel).typedInput('type', typeVal);
  }
  RED.nodes.registerType('MC Write', {
    category: 'MITSUBISHI',
    color: '#3FADB5',
    defaults: {
      name: { value: "" },
      topic: { value: "" },
      connection: { type: "MC Protocol Connection", required: true },
      data: { value: "" },
      address: { value: "", validate: RED.validators.typedInput("addressType") },
      addressType: { value: "str" },
      data: { value: "", validate: RED.validators.typedInput("dataType") },
      dataType: { value: "str" },
    },
    inputs: 1,
    outputs: 1,
    inputLabels: "Trigger request",
    outputLabels: "Write result",
    align: "right",
    icon: "write.png",
    label: function () {
      return this.name || "MC Write";
    },
    oneditprepare: function () {
      debugger;
      var sti = setupTypedInput.bind(this);
      sti('address', ['msg', 'flow', 'global', 'str', 'env'], 'str');//addr
      sti('data', ['msg', 'flow', 'global','num','str', {
        value: 'csv',
        label: 'csv',
        icon: "red/images/typedInput/09.png"
      },], 'num');
    }
  });
</script>

<script type="text/x-red" data-template-name="MC Write">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="write.label.name"> Name</span></label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <div class="form-row">
    <label for="node-input-connection"><i class="icon-globe"></i><span data-i18n="write.label.connection"> Connection</span></label>
    <input type="text" id="node-input-connection">
  </div>
  <div class="form-row">
    <label for="node-input-address"><i class="fa fa-envelope"></i><span data-i18n="ab-df1-read.label.address"> Address</span></label>
    <input type="hidden" id="node-input-addressType">
    <input style="width: 70%" type="text" id="node-input-address" placeholder="D0">
  </div>

  <div class="form-row">
    <label for="node-input-data"><i class="fa fa-table"></i> <span data-i18n="write.label.data"> Data</span></label>
    <input type="hidden" id="node-input-dataType">
    <input style="width: 70%" type="text" id="node-input-data" >
  </div>
 
</script>

<script type="text/x-red" data-help-name="MC Write">
  <p>Write data to an MITSUBISHI PLC using mcprotocol protocol</p>
  <h3>Inputs</h3>
  <dl class="message-properties">
    <dt class="required">Connection<span class="property-type">DF1 Connection</span></dt>
    <dd>The PLC connection</dd>
    <dt class="required">Address<span class="property-type">number | string | payload</span></dt>
    <dd>PLC Memory Address</dd>
    <dt class="required">Data<span class="property-type">Array<number> | number | string | payload </span></dt>
    <dd>Data to be written to PLC starting at specified address.</dd>
    <p><i>INFO: To open / close the MC Protocol connection, send boolean <code>true</code> in <code>msg.connect</code> or <code>msg.disconnect</code>.  Alternatively, send string <code>connect</code> or <code>disconnect</code> in <code>msg.topic</code> to the any mc read / mc write node.</i></p>
  </dl>
  <h3>Outputs</h3>
  <dl class="message-properties">
    <dt>payload <span class="property-type">boolean</span></dt>
    <dd>Payload will be <code>true</code> if successful</dd>
    <dt>mcWriteDetails <span class="property-type">object</span></dt>
    <dd><code>msg.mcWriteDetails</code> will contain properties like <code>isGood</code>, <code>quality</code>, <code>TAG</code> etc.  The user should inspect these to determine if the PLC write command was unsuccessful.</dd>
    <dd>Use a debug node to inspect the object</dd>
  </dl>
  <h3>Details</h3>
  <p>
    If an error occurs the output of this node may still be triggered. 
    In this case, the payload maybe invalid but the <code>mcWriteDetails</code> will contain additional information about the problem.
  </p>
  <p>Address format [DS] DEV [DT] DN [.BIT] [,CNT] [:OPTS]...  
    <ol>
      <li>[1] DS	 - {string} Digit specifier (e.g. K4) [optional]</li>
      <li>[2] DEV  - {string} Device (Y|X|D|F|W|B|R|etc)</li>
      <li>[3] DT 	 - {string} Data type (REAL|FLOAT|STR|WORD|DWORD|DINT|UINT) [optional]</li>
      <li>[4] DN 	 - {int} Device number</li>
      <li>[5] BIT  - {int} Bit number [optional]</li>
      <li>[6] CNT  - {int} Count of items [optional]</li>
      <li>[7] OPTS - {JSON} Options for specifying network and station e.g. {N:2,S:3} would attempt to route the message to station 3 on network 2 [optional]</li>
    </ol>
    <i>Notes...<br>DS and DT should not be used together. <br>if CNT is omitted, then <code>1</code> is assumed. <br>DN may be DEC or HEX depending on the notation of the Device e.g. YA, X1E, WBA4, B3D   </i> 
  </p>
  <p>data must match the address style e.g...
    <table>
      <tr>
        <td>Address Example</td>
        <td>Expected Type</td>
        <td>Notes</td>
        </tr>
      <tr>
        <td>K4Y0</td>
        <td>int</td>
        <td>âˆ’32,768 to 32,767</td>
        </tr>
      <tr>
        <td>DSTR0,10</td>
        <td>string</td>
        <td>Upto 10 chars long</td>
        </tr>
      <tr>
        <td>DUINT0,10</td>
        <td>UINT[10]</td>
        <td>10 WD array containing values 0 to 65535</td>
        </tr>
    </table>
  </p>
</script>